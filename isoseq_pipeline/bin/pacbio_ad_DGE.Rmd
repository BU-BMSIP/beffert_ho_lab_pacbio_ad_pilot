## differential gene expression
## method referenced: https://www.biorxiv.org/content/10.1101/2023.09.20.558220v1.full

```{r}
# libraries
library(DESeq2)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(tidyr)
```

```{r}
# read in raw counts matrix

new_col_names <- c("gene","bc01_CTRL", "bc02_CTRL", "bc03_CTRL", "bc04_CTRL", "bc09_AD", "bc10_AD", "bc11_AD", "bc12_AD")

counts <- read.delim("../results/isoquant/isoquant.discovered_gene_grouped_counts.linear.tsv", header=TRUE, sep="\t") %>%
  pivot_wider(names_from = group_id, values_from = count) %>%
  select("X.feature_id", sort(colnames(.))) %>%
  arrange(X.feature_id) %>%
  as.data.frame() %>%
  na.omit()

names(counts) <- new_col_names

nrow(counts)
head(counts)
```

```{r}
# filter counts to keep genes with at least 2 samples with counts >= 10

counts_filtered <- counts[rowSums(counts[-1] >= 10)>= 2, ]

nrow(counts_filtered)
counts_filtered
```

```{r}
# create deseq2 object

# counts matrix
counts_matrix <- as.matrix(counts_filtered[-1])
row.names(counts_matrix) <- counts_filtered$gene
```

```{r}
# col data
col_data <- tibble(
  sample_name = colnames(counts_filtered[-1])) %>%
  separate(sample_name,c("sample","condition"),sep="_",remove=FALSE) %>%
  mutate(condition=as.factor(condition))

col_data
```

```{r}
# design matrix and dds object
design <- formula(~ condition)
dds <- DESeqDataSetFromMatrix(
  countData=counts_matrix,
  colData=col_data,
  design=design
)
```


```{r}
# run deseq2
dds <- DESeq(dds)
res <- results(dds) %>%
  as.data.frame()

res %>%
  arrange(padj)
```
```{r}
# pca

```

